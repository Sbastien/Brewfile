name: Check Outdated Packages

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9am UTC
  workflow_dispatch:

jobs:
  check-outdated:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install packages from Brewfile
        run: |
          brew bundle --file=Brewfile --no-lock
        continue-on-error: true

      - name: Check for outdated packages
        id: outdated
        run: |
          echo "Checking for outdated packages..."
          outdated=$(brew outdated --verbose 2>/dev/null || true)
          
          if [ -n "$outdated" ]; then
            echo "outdated_found=true" >> $GITHUB_OUTPUT
            echo "### Outdated Packages" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$outdated" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "outdated_found=false" >> $GITHUB_OUTPUT
            echo "### All packages are up to date!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for deprecated packages
        run: |
          echo "Checking for deprecated packages..."
          echo "### Deprecated Check" >> $GITHUB_STEP_SUMMARY
          
          while IFS= read -r line; do
            pkg=$(echo "$line" | grep -oE '^(brew|cask)\s+"[^"]+"' | grep -oE '"[^"]+"' | tr -d '"')
            if [ -n "$pkg" ]; then
              info=$(brew info "$pkg" 2>/dev/null || true)
              if echo "$info" | grep -qi "deprecated\|disabled"; then
                echo "::warning::Package $pkg may be deprecated"
                echo "- ⚠️ $pkg may be deprecated" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done < Brewfile
          
          echo "Deprecation check complete" >> $GITHUB_STEP_SUMMARY
